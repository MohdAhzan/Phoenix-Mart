{% extends 'store/base.html' %}
{% load static %}
{% block content %}

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Login to Continue</h5>
      </div>
      <div class="modal-body">
        <button type="button" class="btn btn-primary w-100" onclick="googleLoginPopup()">
            <i class="bi bi-google"></i> Continue with Google
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container my-5">
    <h1 class="text-center fw-bold mb-4">Born Fresh Everyday</h1>
    <div class="row g-4">
        {% for product in products %}
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card product-card shadow-sm" style="max-width: 240px; margin: 0 auto;">
                <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}" style="height: 160px; object-fit: cover;">
                <div class="card-body text-center p-3">
                    <h5 class="card-title" style="font-size: 1rem;">{{ product.name }}</h5>
                    <p class="text-muted small mb-3 text-justify" style="hyphens: auto; text-align-last: center;">
                        {{ product.description|truncatewords:14 }}
                    </p>
                    <form method="post" action="{% url 'store:add_to_cart' product.id %}" class="add-to-cart-form">
                        {% csrf_token %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <p class="fw-bold mb-0">Â£{{ product.price }}</p>
                            <div class="input-group" style="width: 100px;">
                                <input type="number" name="quantity" class="form-control form-control-sm text-center" value="1" min="1" max="{{ product.stock }}">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-dark btn-sm w-100 add-to-cart-btn" data-product-id="{{ product.id }}">Add to Cart</button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
    let currentForm = null;
    
    addToCartButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            currentForm = this.closest('form');
            
            // Check if user is authenticated
            const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
            
            if (isAuthenticated) {
                // If authenticated, submit the form directly
                submitAddToCartForm(currentForm);
            } else {
                // If not authenticated, show login modal
                loginModal.show();
            }
        });
    });
    
    // Handle login form submission
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Submit the login form via AJAX
        fetch(this.action, {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Login successful, now submit the add to cart form
                loginModal.hide();
                submitAddToCartForm(currentForm);
            } else {
                // Show error message
                alert(data.message || 'Login failed. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    });
    
    function submitAddToCartForm(form) {
        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update cart count in the navbar
                document.getElementById('cart-count').textContent = data.cart_count;
                
                // Show success message
                alert('Product added to cart successfully!');
            } else {
                alert('Failed to add product to cart. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
});
function googleLoginPopup() {
    const width = 500, height = 600;
    const left = (screen.width / 2) - (width / 2);
    const top = (screen.height / 2) - (height / 2);

    window.open(
        "{% url 'social:begin' 'google-oauth2' %}", 
        "GoogleLogin", 
        `width=${width},height=${height},top=${top},left=${left}`
    );
}

</script>
{% endblock %}