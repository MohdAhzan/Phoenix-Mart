{% extends 'store/base.html' %} {% load static %} {% block content %} {% include
"modal/checkout.html" %}
<style>
  .card-img-top {
    width: 100%;
    /* Set a 16:9 aspect ratio (9 / 16 * 100% = 56.25%) */
    padding-bottom: 56.25%;
    position: relative;
    overflow: hidden;
  }

  .card-img-top img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* This makes the image fill the container, cropping excess */
    object-fit: cover;
  }
</style>
<!-- Login Modal -->
<div
  class="modal fade"
  id="loginModal"
  tabindex="-1"
  aria-labelledby="loginModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Login to Continue</h5>
      </div>
      <div class="modal-body">
        <a
          href="{% url 'social:begin' 'google-oauth2' %}?next=/"
          class="btn btn-primary w-100"
        >
          <i class="bi bi-google"></i> Continue with Google
        </a>
      </div>
    </div>
  </div>
</div>

<div class="container my-5">
  <h1 class="text-center fw-bold mb-4">Born Fresh Everyday</h1>
  <div class="row g-4 justify-content-center">
    {% for product in products %}
    <div class="col-6 col-sm-6 col-md-4 col-lg-3 d-flex">
      <div class="card product-card shadow-sm flex-fill text-center">
        <div class="card-img-top">
          <img src="{{ product.image.url }}" alt="{{ product.name }}" />
        </div>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ product.name }}</h5>
          <p class="card-text text-muted">
            {{ product.description|truncatewords:12 }}
          </p>

          <div
            class="d-flex justify-content-center align-items-center mb-2 mt-auto"
          >
            <h6 class="fw-bold mb-0 me-2">Â£{{ product.price }}</h6>
            <input
              type="number"
              min="1"
              value="1"
              class="form-control"
              style="max-width: 80px"
            />
          </div>

          <button class="btn btn-dark w-100">Add to Cart</button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
      const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      let currentForm = null;

      addToCartButtons.forEach(button => {
          button.addEventListener('click', function(e) {
              e.preventDefault();
              currentForm = this.closest('form');

              // Check if user is authenticated
              const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};

              if (isAuthenticated) {
                  // If authenticated, submit the form directly
                  submitAddToCartForm(currentForm);
              } else {
                  // If not authenticated, show login modal
                  loginModal.show();
              }
          });
      });

      // Handle login form submission
      document.getElementById('loginForm').addEventListener('submit', function(e) {
          e.preventDefault();

          // Submit the login form via AJAX
          fetch(this.action, {
              method: 'POST',
              body: new FormData(this),
              headers: {
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Login successful, now submit the add to cart form
                  loginModal.hide();
                  submitAddToCartForm(currentForm);
              } else {
                  // Show error message
                  alert(data.message || 'Login failed. Please try again.');
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('An error occurred. Please try again.');
          });
      });

      function submitAddToCartForm(form) {
          fetch(form.action, {
              method: 'POST',
              body: new FormData(form),
              headers: {
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Update cart count in the navbar
                  document.getElementById('cart-count').textContent = data.cart_count;

                  // Show success message
                  alert('Product added to cart successfully!');
              } else {
                  alert('Failed to add product to cart. Please try again.');
              }
          })
          .catch(error => {
              console.error('Error:', error);
              alert('An error occurred. Please try again.');
          });
      }
  });
  function googleLoginPopup() {
      const width = 500, height = 600;
      const left = (screen.width / 2) - (width / 2);
      const top = (screen.height / 2) - (height / 2);

      window.open(
          "{% url 'social:begin' 'google-oauth2' %}",
          "GoogleLogin",
          `width=${width},height=${height},top=${top},left=${left}`
      );
  }
</script>
{% endblock %}
